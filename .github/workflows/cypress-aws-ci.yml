name: Cypress AWS CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # -------------------------------------------------
  # 1. Static Code Analysis (CodeQL)
  # -------------------------------------------------
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


  # -------------------------------------------------
  # 2. Run Cypress Tests
  # -------------------------------------------------
  cypress-tests:
    name: Run Cypress Tests
    runs-on: ubuntu-latest
    needs: static-analysis

    env:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
      BASE_URL: ${{ secrets.BASE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"

      - name: Clear Cypress cache
        run: npx cypress cache clear

      - name: Install dependencies + Cypress
        run: |
          npm ci
          npx cypress install

      - name: Check application availability
        run: |
          echo "Checking BASE_URL: $BASE_URL"
          curl -I "$BASE_URL"

      - name: Run Cypress Tests
        run: |
          npx cypress run \
            --reporter mochawesome \
            --reporter-options reportDir=cypress/reports,overwrite=false,html=false,json=true || true

      - name: Merge & Generate Mochawesome report
        run: |
          mkdir -p cypress/reports
          if ls cypress/reports/*.json 1> /dev/null 2>&1; then
            echo "Merging mochawesome JSON reports..."
            npx mochawesome-merge cypress/reports/*.json > cypress/reports/output.json || echo "{}" > cypress/reports/output.json
            echo "Generating HTML report..."
            npx mochawesome-report-generator cypress/reports/output.json -f index -o cypress/reports
          else
            echo "âš  No mochawesome JSON files found, skipping merge."
          fi

      - name: Upload Cypress Test Reports (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports
          path: cypress/reports/


# -------------------------------------------------
# 3. Upload Reports to AWS S3 (LATEST + ARCHIVE)
# -------------------------------------------------
upload-to-s3:
  name: Upload Test Reports to S3
  runs-on: ubuntu-latest
  needs: cypress-tests

  steps:
    - name: Download Test Artifact
      uses: actions/download-artifact@v4
      with:
        name: cypress-reports

    - name: Generate timestamp for archive folder
      id: timestamp
      run: echo "TS=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-2

    - name: Upload report to S3 (latest + archive)
      run: |
        echo "Uploading latest report..."
        aws s3 rm s3://abhinandan-cypress-results/reports/latest/ --recursive || true
        aws s3 cp cypress/reports s3://abhinandan-cypress-results/reports/latest/ --recursive --acl public-read

        echo "Uploading archive copy..."
        aws s3 cp cypress/reports s3://abhinandan-cypress-results/reports/archive/$TS/ --recursive --acl public-read

    - name: Print uploaded paths
      run: |
        echo "Latest report: s3://abhinandan-cypress-results/reports/latest/index.html"
        echo "Archived report: s3://abhinandan-cypress-results/reports/archive/$TS/index.html"



  # -------------------------------------------------
  # 4. Trigger AWS CodeBuild
  # -------------------------------------------------
  trigger-codebuild:
    name: Trigger CodeBuild Project
    runs-on: ubuntu-latest
    needs: upload-to-s3

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Trigger CodeBuild
        run: aws codebuild start-build --project-name abhinandan-cypress-build


# -------------------------------------------------
# 5. Notify via AWS SNS (Latest + Archive + Cleanup)
# -------------------------------------------------
sns-notification:
  name: Send SNS Notification
  runs-on: ubuntu-latest
  needs: upload-to-s3

  steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-2

    - name: Generate URLs for reports
      id: urls
      run: |
        LATEST_URL=$(aws s3 presign s3://abhinandan-cypress-results/reports/latest/index.html --expires-in 604800)
        ARCHIVE_URL=$(aws s3 presign s3://abhinandan-cypress-results/reports/archive/$TS/index.html --expires-in 604800)

        echo "LATEST_URL=$LATEST_URL" >> $GITHUB_ENV
        echo "ARCHIVE_URL=$ARCHIVE_URL" >> $GITHUB_ENV

    - name: Cleanup archive older than 30 days
      run: |
        echo "ðŸ§¹ Cleaning up archives older than 30 days..."

        # Get timestamp of 30 days ago
        LIMIT=$(date -d "30 days ago" +"%Y-%m-%d")

        # List archive folders
        FOLDERS=$(aws s3api list-objects-v2 \
          --bucket abhinandan-cypress-results \
          --prefix reports/archive/ \
          --delimiter "/" \
          --query "CommonPrefixes[].Prefix" \
          --output text)

        for FOLDER in $FOLDERS; do
          # Extract date portion from folder name
          FOLDER_DATE=$(echo $FOLDER | cut -d'/' -f3 | cut -d'_' -f1)

          if [[ "$FOLDER_DATE" < "$LIMIT" ]]; then
            echo "ðŸ”´ Deleting old archive: $FOLDER"
            aws s3 rm s3://abhinandan-cypress-results/$FOLDER --recursive
          else
            echo "ðŸŸ¢ Keeping archive: $FOLDER"
          fi
        done

    - name: Send SNS Notification
      run: |
        printf "%s\n\n%s\n%s\n\n%s\n%s\n\n%s\n" \
          "âœ… Cypress CI/CD Pipeline Completed Successfully!" \
          "Latest Report: $LATEST_URL" \
          "Archived Report ($TS): $ARCHIVE_URL" \
          "Note: Archives older than 30 days are automatically deleted." \
          "HTML reports are publicly accessible." > message.txt

        aws sns publish \
          --topic-arn arn:aws:sns:ap-south-2:136905788804:abhinandan-cypress-sns \
          --message file://message.txt




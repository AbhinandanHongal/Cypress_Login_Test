name: Cypress AWS CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # -----------------------------
  # 1. Static Code Analysis (CodeQL)
  # -----------------------------
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


  # -----------------------------
  # 2. Run Cypress Tests
  # -----------------------------
  cypress-tests:
    name: Run Cypress Tests
    runs-on: ubuntu-latest
    needs: static-analysis

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Run Cypress tests
        run: npx cypress run --config baseUrl="https://www.google.com"
        continue-on-error: true

      - name: Merge and Generate Mochawesome Report
        run: |
          echo "Merging Mochawesome JSON files..."
          if ls cypress/reports/**/*.json 1> /dev/null 2>&1; then
            npx mochawesome-merge "cypress/reports/**/*.json" > cypress/reports/output.json
            npx marge cypress/reports/output.json --reportDir cypress/reports --reportFilename index.html
            echo "âœ… HTML report generated successfully."
          else
            echo "âš ï¸ No JSON files found to merge. Skipping report generation."
          fi

      - name: Verify artifact contents
        run: |
          echo "Listing contents of cypress/reports directory"
          ls -R cypress/reports || true

      - name: Upload Cypress Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports
          path: |
            cypress/reports/
            cypress/screenshots/
            cypress/videos/


  # -----------------------------
  # 3. Upload Reports to AWS S3
  # -----------------------------
  upload-to-s3:
    name: Upload Test Reports to S3
    runs-on: ubuntu-latest
    needs: cypress-tests

    steps:
      - name: Download Test Artifact
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports

      - name: Verify artifact after download
        run: |
          echo "Listing contents"
          ls -R

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-2

      - name: Upload reports to S3
        run: |
          if [ -d "reports" ]; then
            aws s3 cp reports s3://abhinandan-cypress-results/reports/ --recursive
          else
            echo "reports folder not found"
          fi

          if [ -d "screenshots" ]; then
            aws s3 cp screenshots s3://abhinandan-cypress-results/screenshots/ --recursive
          else
            echo "screenshots folder not found"
          fi

          if [ -d "videos" ]; then
            aws s3 cp videos s3://abhinandan-cypress-results/videos/ --recursive
          else
            echo "videos folder not found"
          fi


  # -----------------------------
  # 4. Trigger AWS CodeBuild
  # -----------------------------
  trigger-codebuild:
    name: Trigger CodeBuild Project
    runs-on: ubuntu-latest
    needs: upload-to-s3

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Trigger CodeBuild
        run: |
          aws codebuild start-build --project-name abhinandan-cypress-build


  # -----------------------------
  # 5. Notify via AWS SNS
  # -----------------------------
  sns-notification:
    name: Send SNS Notification
    runs-on: ubuntu-latest
    needs: trigger-codebuild

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-2

      - name: Capture Run Start and End Time
        id: capture_time
        run: |
          echo "START_TIME=$(date -u -d "${{ github.event.head_commit.timestamp }}" '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "END_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          start=$(date -d "${{ github.event.head_commit.timestamp }}" +%s)
          end=$(date +%s)
          duration=$((end - start))
          echo "DURATION=${duration}s" >> $GITHUB_ENV

      - name: Find latest Cypress HTML report and generate pre-signed URL
        id: find_latest
        run: |
          echo "Finding latest HTML report in S3 bucket..."

          latest_html=$(aws s3api list-objects-v2 \
            --bucket abhinandan-cypress-results \
            --prefix reports/ \
            --query "reverse(sort_by(Contents[?ends_with(Key, '.html')], &LastModified))[0].Key" \
            --output text)

          if [ "$latest_html" == "None" ] || [ -z "$latest_html" ]; then
            echo "No HTML report found in S3. Using default reports/index.html"
            latest_html="reports/index.html"
          fi

          echo "Latest HTML report found: $latest_html"
          url=$(aws s3 presign s3://abhinandan-cypress-results/$latest_html --expires-in 604800)
          echo "REPORT_URL=$url" >> $GITHUB_ENV

      - name: Send SNS notification
        run: |
          aws sns publish \
            --topic-arn arn:aws:sns:ap-south-2:136905788804:abhinandan-cypress-sns \
            --message "$(echo -e 'âœ… Cypress CI/CD Pipeline Completed Successfully!\n\nğŸ“… Start Time: '$START_TIME'\nğŸ•’ End Time: '$END_TIME'\nâ±ï¸ Total Duration: '$DURATION'\n\nğŸ“„ Cypress HTML Report:\n'$REPORT_URL'\n\nReports have been uploaded to S3 and CodeBuild was triggered successfully.')"

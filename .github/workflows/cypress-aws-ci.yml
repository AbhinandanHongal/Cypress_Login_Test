name: Cypress AWS CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # -------------------------------------------------
  # 1. Static Code Analysis (CodeQL)
  # -------------------------------------------------
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # -------------------------------------------------
  # 2. Run Cypress Tests
  # -------------------------------------------------
  cypress-tests:
    name: Run Cypress Tests
    runs-on: ubuntu-latest
    needs: static-analysis

    env:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
      BASE_URL: ${{ secrets.BASE_URL }}
      RUN_ID: run-${{ github.run_number }}
      REPORT_DIR: cypress/reports/run-${{ github.run_number }}

    steps:
      - name: Capture Start Time
        run: echo "PIPELINE_START_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"

      - name: Prepare report directory
        run: |
          echo "Using REPORT_DIR=$REPORT_DIR"
          rm -rf "$REPORT_DIR"
          mkdir -p "$REPORT_DIR"  

      - name: Clear Cypress cache
        run: npx cypress cache clear

      - name: Install dependencies and Cypress
        run: |
          npm ci
          npx cypress install

      - name: Verify application availability
        run: curl -I "$BASE_URL"

      - name: Run Cypress Tests
        run: |
          set +e
          npx cypress run \
            --reporter mochawesome \
            --reporter-options reportDir=$REPORT_DIR,overwrite=false,html=false,json=true
          echo "CYPRESS_EXIT_CODE=$?" >> $GITHUB_ENV
          set -e

      - name: Merge mochawesome reports
        run: |
          JSON_FILES=$(ls $REPORT_DIR/mochawesome*.json 2>/dev/null || true)

          if [ -z "$JSON_FILES" ]; then
            echo "⚠️ No mochawesome JSON files found. Skipping merge."
            exit 0
          fi  

          npx mochawesome-merge $JSON_FILES > $REPORT_DIR/output.json

          node -e "JSON.parse(require('fs').readFileSync('$REPORT_DIR/output.json','utf8'))"

          npx mochawesome-report-generator \
          $REPORT_DIR/output.json \
          --reportDir $REPORT_DIR \
          --reportFilename index \
          --charts true

          echo "✅ Mochawesome report generated at $REPORT_DIR"


      - name: Upload Cypress Reports (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports-${{ github.run_number }}
          path: ${{ env.REPORT_DIR }}
  

  # -------------------------------------------------
  # 3. Upload to S3
  # -------------------------------------------------
  upload-to-s3:
    name: Upload Reports to S3
    runs-on: ubuntu-latest
    needs: cypress-tests

    steps:
      - name: Download Test Artifact
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-${{ github.run_number }}
          path: cypress/reports/run-${{ github.run_number }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-2

      - name: Upload Reports to S3 (Public Folder)
        run: |
          RUN_DIR="run-${{ github.run_number }}"
          LOCAL_PATH="cypress/reports/$RUN_DIR"
          S3_PATH="s3://abhinandan-cypress-results/reports/$RUN_DIR/"

          if [ -d "$LOCAL_PATH" ]; then
            echo "⬆ Uploading reports from $LOCAL_PATH to $S3_PATH"
            aws s3 cp "$LOCAL_PATH" "$S3_PATH" --recursive
          else
            echo "❌ Report folder missing: $LOCAL_PATH"
            exit 1
          fi

      - name: Build Screenshot Links
        run: |
          SCREENSHOT_LINKS=""
          for file in $(aws s3 ls s3://abhinandan-cypress-results/screenshots/ --recursive | awk '{print $4}'); do
            SCREENSHOT_LINKS+="https://abhinandan-cypress-results.s3.ap-south-2.amazonaws.com/$file\n"
          done
          echo "SCREENSHOT_LINKS<<EOF" >> $GITHUB_ENV
          echo -e "$SCREENSHOT_LINKS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Build Video Links
        run: |
          VIDEO_LINKS=""
          for file in $(aws s3 ls s3://abhinandan-cypress-results/videos/ --recursive | awk '{print $4}'); do
            VIDEO_LINKS+="https://abhinandan-cypress-results.s3.ap-south-2.amazonaws.com/$file\n"
          done
          echo "VIDEO_LINKS<<EOF" >> $GITHUB_ENV
          echo -e "$VIDEO_LINKS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


  # -------------------------------------------------
  # 4. Trigger CodeBuild
  # -------------------------------------------------
  trigger-codebuild:
    name: Trigger CodeBuild Project
    runs-on: ubuntu-latest
    needs: upload-to-s3

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Trigger CodeBuild
        run: aws codebuild start-build --project-name abhinandan-cypress-build


  # -------------------------------------------------
  # 5. SNS Notification
  # -------------------------------------------------
  sns-notification:
    name: Send SNS Notification
    runs-on: ubuntu-latest
    needs:
      - trigger-codebuild
      - upload-to-s3

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-2

      - name: Capture End Time
        run: echo "PIPELINE_END_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV

      - name: Send SNS notification
        run: |
          PUBLIC_URL="https://abhinandan-cypress-results.s3.ap-south-2.amazonaws.com/reports/run-${{ github.run_number }}/index.html"

          MSG="Cypress CI/CD Pipeline Completed!

          Start Time: $PIPELINE_START_TIME
          End Time:   $PIPELINE_END_TIME

          HTML Report:
          $PUBLIC_URL

          Screenshots:
          $SCREENSHOT_LINKS

          Videos:
          $VIDEO_LINKS
          "

          echo "$MSG" > message.txt

          aws sns publish \
            --topic-arn arn:aws:sns:ap-south-2:136905788804:abhinandan-cypress-sns \
            --message file://message.txt
